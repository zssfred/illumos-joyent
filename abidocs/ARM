#
# This file and its contents are supplied under the terms of the
# Common Development and Distribution License ("CDDL"), version 1.0.
# You may only use this file in accordance with the terms of version
# 1.0 of the CDDL.
#
# A full copy of the text of the CDDL should have accompanied this
# source.  A copy of the CDDL is also available via the Internet at
# http://www.illumos.org/license/CDDL.
#

#
# Copyright (c) 2013, Joyent, Inc.  All rights reserved.
#

######################################################
# ARM illumos Application Binary Interface Supplement#
######################################################

ARM has a generic Application Binary Interface (ABI) which describes aspects
about how procedure calls, ELF relocations, and several other aspects work. The
ABI provided by ARM purposefully has some missing holes due to its generic
nature. The illumos ABI is similar to the GNU/Linux ABI[0] and this document is
inspired and based on it as well.

## Change history ##

+---------+-------------+------------------+
| Version | Date        | Change           |
+---------+-------------+------------------+
+---------+-------------+------------------+
| 0.0.1   | 24 Aug 2013 | First Pass       |
+---------+-------------+------------------+
| 0.0.2   | 15 Feb 2015 | Deprecate ARMv6  |
+---------+-------------+------------------+

## Comments ##

If you find that there is something missing, incorrect, or you feel an
overwhelming to punch the person to blame for this in the face, contact Robert
Mustacchi <rm@fingolfin.org>.

## Scope and Architecture Support ##

This document applies to all 32-bit (AARCH32) compatible ARM environments.
Compatible ARM chips will have the following features at a minimum:

  o ARMv7 architecture support
  o VFPv3 co-processor with 16 64-bit registers
  o Support for unaligned memory access
  o Support for Thread and Context ID registers in CP15

This document does not apply to AARCH64 compatible ARM environments; however,
AARCH32 modes on those processors are subject to this.

This document does not apply to THUMB environments. illumos does not currently
support THUMB modes on the processors. This document will be updated for THUMB
support when we support it.

# Procedure Call Standard for the ARM Architecture #
####################################################

## Base Standard ##

The illumos ABI is based off of the document published by ARM: Procedure Call
Standard for the ARM architecture[1] (AAPCS). The ARM document number is ARM IHI
0042E, presently the release from the 30 Nov. 2012. Specifically see Section 5
for the Procedure Call Standard.

illumos follows this ABI with the following exceptions:

### Use of Register r9 (AAPCS 5.1) ###

The AAPCS leaves r9 as a platform register. Because the AAPCS no longer
designates a frame pointer, illumos designates r9 as the frame pointer. We
believe that having a frame pointer is essential to debugging. It allows tooling
like DTrace, mdb, pstack, etc., to provie better runtime debugging. To try and
follow the rest of the ABI, we do not want to use r11 which was previously
considered the frame pointer. Similarly, iOS[2], based on the AAPCS, uses r7. It
may prove that violating the AAPCS and marking r7 as the frame pointer and
returning r9 to v6 will be the more practical option.

### wchar_t type ###

The wchar_t maintains the same type it has historically on illumos. It is a long
in 32-bit environments.

### Enumerations ###

Enumerations are always either an int or unsigned int.

# Elf for the ARM Architecture #
################################

illumos follows the ARM document 'ELF for the ARM Architecture'[3]. Document
number: ARM IHI 0044E pulished on 30 Nov. 2013.

The reolocations R_ARM_TARGET1 and R_ARM_TARGET2 are not currently supported.

# C Library API for the ARM Architecture #
##########################################

ARM defines what a C89 run-time library for C progarms might look like in the
document: C Library ABI for the ARM Architecture[4]. Document number ARM IHI
0039C.  Publish on 30 Nov. 2012.

illumos does not support the AEABI portable environment as described in that
document. illumos will never defined the preprocessor symbol _AEABI_PORTABLE.

# C++ and DWARF #
#################

At this time, C++ and DWARF for illumos on ARM are not defined.

# Architectural use of CP15, c13, Thread and process ID Registers #
###################################################################

The ARM architecture provides three registers to serve as thread and process ID
registers which are available in CP15, c13. Each one has different semantics for
read and write based on mode. You get the following three:

  o User read/write, Privileged read/write (CP15, c13, c0, 2)
  o User read-only,  Privileged read/write (CP15, c13, c0, 3)
  o Privileged read/write only (CP15, c13, c0, 4)

These are reserved for use by the OS for ARM. At this time we allocate them as
follows:

  o The user read/write register will be used for the user's curthread. It
    points to a ulwp_t.
  o The user read-only register is reserved for future use by illumos.
  o The privileged read/write register will be for the kernel's curthread. It
    points to a kthread_t.

# References #
##############
[0] CodeSourcery ARM GNU/Linux Application Binary Interface Supplement (2005)
{http://www.boost.org/doc/libs/1_51_0_beta1/libs/context/doc/pdf/arm-linux-aapcs.pdf}
[1] http://infocenter.arm.com/help/topic/com.arm.doc.ihi0042e/IHI0042E_aapcs.pdf
[2] https://developer.apple.com/library/ios/documentation/Xcode/Conceptual/iPhoneOSABIReference/Introduction/Introduction.html
[3] http://infocenter.arm.com/help/topic/com.arm.doc.ihi0044e/IHI0044E_aaelf.pdf
[4] http://infocenter.arm.com/help/topic/com.arm.doc.ihi0039c/IHI0039C_clibabi.pdf
